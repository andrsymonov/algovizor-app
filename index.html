<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlgoVizor - Backtesting & Optimization</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            max-height: 400px;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Dark mode aesthetics for inputs and textarea */
        input[type="text"], input[type="number"], input[type="date"], select, textarea {
            background-color: #374151; /* gray-700 */
            border: 1px solid #4b5563; /* gray-600 */
            color: #d1d5db; /* gray-300 */
            padding: 8px 12px;
            border-radius: 6px;
            width: 100%;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus, textarea:focus {
            border-color: #3b82f6; /* blue-500 */
            outline: none;
        }

        .card {
            background-color: #1f2937; /* gray-800 */
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            padding: 24px;
        }

        .text-accent {
            color: #f59e0b; /* Amber for accents */
        }

        .btn-primary {
            background-color: #10b981; /* Emerald for positive action */
            color: #1f2937;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #059669;
        }

        .btn-secondary {
            background-color: #374151;
            color: #d1d5db;
            border: 1px solid #4b5563;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .nav-item {
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .nav-item:hover {
            background-color: #374151;
        }

        .active-nav {
            background-color: #4b5563;
            color: white;
            font-weight: bold;
        }

        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Position above the tooltip container */
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-4 md:p-8">
        <header class="flex flex-col md:flex-row justify-between items-center py-4 border-b border-gray-700 mb-6">
            <h1 class="text-3xl font-extrabold text-accent">AlgoVizor<span class="text-gray-400 text-xl font-light ml-2">Beta</span></h1>
            <div class="flex items-center space-x-4 mt-4 md:mt-0">
                <div class="flex items-center space-x-2">
                    <label for="lang-select" class="text-sm" data-i18n="language_label">Language:</label>
                    <select id="lang-select" class="bg-gray-800 border border-gray-700 text-gray-100 rounded-md p-1 text-sm" onchange="window.setLanguage(this.value)">
                        <option value="en">English</option>
                        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                    </select>
                </div>
                <button id="accountButton" onclick="window.toggleModal('accountModal')" class="btn-secondary px-4 py-2 rounded-lg text-sm" data-i18n="account_button">Account</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <aside class="lg:col-span-1 space-y-6">
                <div id="statusCard" class="card">
                    <h2 class="text-xl font-semibold mb-3 text-accent" data-i18n="status_title">User Status</h2>
                    <div class="flex justify-between mb-2">
                        <span data-i18n="user_id_label">User ID:</span>
                        <span id="userIdDisplay" class="truncate text-sm text-gray-400" title="">Loading...</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span data-i18n="tier_label">Subscription Tier:</span>
                        <span id="tierDisplay" class="font-bold text-lg text-red-400">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span data-i18n="tests_remaining_label">Tests Remaining:</span>
                        <span id="testsUsedDisplay" class="font-bold text-lg">Loading...</span>
                    </div>
                    <button onclick="window.toggleModal('subscriptionModal')" class="btn-secondary w-full mt-4 py-2 rounded-lg" data-i18n="upgrade_button">Upgrade Plan</button>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-accent" data-i18n="backtest_params_title">Backtest Parameters</h2>

                    <label for="ticker" class="block mb-1 text-sm font-medium" data-i18n="ticker_label">Ticker (e.g., AAPL):</label>
                    <input type="text" id="ticker" value="AAPL" class="mb-3">

                    <label for="timeframe" class="block mb-1 text-sm font-medium" data-i18n="timeframe_label">Timeframe:</label>
                    <select id="timeframe" class="mb-3">
                        <option value="60min">60 min (1 hour)</option>
                        <option value="30min">30 min</option>
                        <option value="4h">4 hours</option>
                        <option value="Daily">Daily (1 day)</option>
                    </select>

                    <label for="strategySelect" class="block mb-1 text-sm font-medium" data-i18n="strategy_label">Strategy:</label>
                    <select id="strategySelect" onchange="window.toggleStrategyInput()" class="mb-3">
                        <option value="ema_crossover">EMA Crossover (Default)</option>
                        <option value="custom_code" disabled data-i18n="custom_code_option">(PRO) Custom Code</option>
                    </select>

                    <div id="emaParams" class="space-y-3 mt-3">
                        <h3 class="font-medium text-gray-400" data-i18n="ema_params_title">EMA Crossover Settings:</h3>
                        <label for="fastEMA" class="block text-sm">Fast EMA (e.g., 50):</label>
                        <input type="number" id="fastEMA" value="50" min="1" class="w-full">
                        <label for="slowEMA" class="block text-sm">Slow EMA (e.g., 200):</label>
                        <input type="number" id="slowEMA" value="200" min="1" class="w-full">
                    </div>

                    <div id="customCode" class="space-y-3 mt-3 hidden">
                        <h3 class="font-medium text-gray-400" data-i18n="custom_code_area_title">Custom Strategy Code (PRO):</h3>
                        <textarea id="customCodeArea" rows="6" class="w-full text-xs font-mono" placeholder="function entryCondition(data, index) { /* your logic */ return data.fastEMA[index] > data.slowEMA[index]; }"></textarea>
                    </div>

                    <h3 class="font-medium text-gray-400 mt-4 mb-2" data-i18n="date_range_title">Date Range:</h3>
                    <label for="startDate" class="block text-sm" data-i18n="start_date_label">Start Date:</label>
                    <input type="date" id="startDate" class="w-full mb-3">
                    <label for="endDate" class="block text-sm" data-i18n="end_date_label">End Date:</label>
                    <input type="date" id="endDate" class="w-full">
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-accent" data-i18n="telegram_alerts_title">Telegram Alerts</h2>
                    <p class="text-sm text-gray-400 mb-3" data-i18n="telegram_info">Receive instant signals (Buy/Sell) to your Telegram chat.</p>

                    <label for="telegramChatId" class="block mb-1 text-sm font-medium">Chat ID:</label>
                    <input type="text" id="telegramChatId" placeholder="Your Telegram Chat ID" class="mb-3">

                    <label for="telegramToken" class="block mb-1 text-sm font-medium">Bot API Token:</label>
                    <input type="text" id="telegramToken" placeholder="Your Bot Token" class="mb-3">

                    <button id="sendSignalButton" onclick="window.sendTelegramSignal('Test', 'Test message from AlgoVizor')" class="btn-secondary w-full py-2 rounded-lg text-sm" data-i18n="send_test_signal">Send Test Signal</button>
                </div>

                <div class="card bg-gray-800 p-4 rounded-lg">
                    <div id="statusMessage" class="text-sm text-yellow-500" data-i18n="status_initial">Enter parameters and run Backtest.</div>
                </div>
            </aside>

            <main class="lg:col-span-3 space-y-6">
                <div class="flex flex-col md:flex-row justify-between space-y-4 md:space-y-0 md:space-x-4">
                    <button id="runBacktestButton" onclick="window.runBacktest()" class="btn-primary flex-1 py-3 rounded-lg text-lg">
                        <span data-i18n="run_backtest_button">Run Backtest</span> (<span id="backtestCostDisplay">1</span> <span data-i18n="test_cost_label">Test</span>)
                    </button>
                    <button id="runOptimizationButton" onclick="window.toggleModal('optimizationModal')" class="btn-secondary flex-1 py-3 rounded-lg text-lg" disabled>
                        <span data-i18n="run_optimization_button">Run Optimization</span> (PRO)
                    </button>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-accent" data-i18n="chart_title">Price & Equity Chart</h2>
                    <div id="chartLoading" class="hidden text-center py-10">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent mx-auto mb-4"></div>
                        <p data-i18n="loading_data">Loading and calculating data...</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>

                <div class="card grid grid-cols-1 md:grid-cols-3 gap-4">
                    <h2 class="col-span-full text-xl font-semibold mb-2 text-accent" data-i18n="results_title">Backtest Results</h2>
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <p class="text-sm text-gray-400" data-i18n="net_return_label">Net Return:</p>
                        <p id="netReturn" class="text-2xl font-bold text-gray-100">--</p>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <p class="text-sm text-gray-400" data-i18n="max_drawdown_label">Max Drawdown:</p>
                        <p id="maxDrawdown" class="text-2xl font-bold text-gray-100">--</p>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <p class="text-sm text-gray-400" data-i18n="trades_label">Total Trades:</p>
                        <p id="totalTrades" class="text-2xl font-bold text-gray-100">--</p>
                    </div>
                </div>
            </main>
        </div>

        <div id="optimizationModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
            <div class="card max-w-2xl w-full">
                <h2 class="text-2xl font-bold mb-4 text-accent" data-i18n="optimization_modal_title">Strategy Optimization (PRO)</h2>
                <p class="mb-6 text-gray-300" data-i18n="optimization_info">Set the range and step size. The system will test all combinations to find the top 3 results based on Net Return.</p>

                <h3 class="text-lg font-semibold mb-3" data-i18n="optimization_range_title">Optimization Range:</h3>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="col-span-1">
                        <label class="block text-sm font-medium mb-1" data-i18n="fast_ema_min">Fast EMA Min:</label>
                        <input type="number" id="optFastMin" value="10" min="1">
                    </div>
                    <div class="col-span-1">
                        <label class="block text-sm font-medium mb-1" data-i18n="fast_ema_max">Fast EMA Max:</label>
                        <input type="number" id="optFastMax" value="60" min="1">
                    </div>
                    <div class="col-span-1">
                        <label class="block text-sm font-medium mb-1" data-i18n="opt_step">Step:</label>
                        <input type="number" id="optStep" value="10" min="1">
                    </div>

                    <div class="col-span-1">
                        <label class="block text-sm font-medium mb-1" data-i18n="slow_ema_min">Slow EMA Min:</label>
                        <input type="number" id="optSlowMin" value="100" min="1">
                    </div>
                    <div class="col-span-1">
                        <label class="block text-sm font-medium mb-1" data-i18n="slow_ema_max">Slow EMA Max:</label>
                        <input type="number" id="optSlowMax" value="300" min="1">
                    </div>
                    <div class="col-span-1">
                        <label class="block text-sm font-medium mb-1" data-i18n="opt_step_filler">Step:</label>
                        <input type="number" value="50" disabled class="bg-gray-700 opacity-50">
                    </div>
                </div>

                <button id="startOptimizationButton" onclick="window.runOptimization()" class="btn-primary w-full py-3 rounded-lg text-lg mb-4" data-i18n="start_optimization">Start Optimization</button>

                <div id="optimizationLoading" class="hidden text-center py-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-accent mx-auto mb-2"></div>
                    <p data-i18n="optimizing_status">Running combinations...</p>
                </div>

                <h3 class="text-lg font-semibold mb-3 mt-4 text-accent" data-i18n="top_results_title">Top 3 Results:</h3>
                <ul id="optimizationResults" class="space-y-2 text-gray-300">
                    <li data-i18n="optimization_placeholder">Run optimization to see results.</li>
                </ul>

                <button onclick="window.toggleModal('optimizationModal')" class="btn-secondary w-full mt-6 py-2 rounded-lg" data-i18n="close_button">Close</button>
            </div>
        </div>

        <div id="subscriptionModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
            <div class="card max-w-3xl w-full">
                <h2 class="text-2xl font-bold mb-4 text-accent" data-i18n="subscription_modal_title">Upgrade Your Plan</h2>
                <p id="subscriptionMessage" class="mb-6 text-lg text-gray-300">You have reached your daily limit of 3 free tests.</p>

                <div style="display: flex; gap: 20px; text-align: center; margin-top: 20px;">
                    <div style="flex: 1; background-color: #1f2937; padding: 25px; border-radius: 12px; border: 2px solid #10b981;">
                        <h3 style="color: #10b981; font-size: 1.5rem; font-weight: bold; margin-bottom: 10px;">FREE</h3>
                        <p style="color: white; font-size: 2.5rem; font-weight: extrabold; margin-bottom: 15px;">$0</p>
                        <ul style="list-style: none; padding: 0; margin-bottom: 20px; color: #d1d5db; text-align: left;">
                            <li style="margin-bottom: 8px;">‚úÖ 3 –±—ç–∫—Ç–µ—Å—Ç–∞ –≤ –¥–µ–Ω—å</li>
                            <li style="margin-bottom: 8px;">‚úÖ –î–æ—Å—Ç—É–ø –∫ EMA Crossover</li>
                            <li style="margin-bottom: 8px;">‚ùå –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è / –û–ø—Ü–∏–æ–Ω—ã</li>
                        </ul>
                        <button style="width: 100%; padding: 10px; background-color: #34d399; color: black; font-weight: bold; border-radius: 8px; cursor: default;">Current Plan</button>
                    </div>

                    <div style="flex: 1; background-color: #1f2937; padding: 25px; border-radius: 12px; border: 2px solid #6366f1;">
                        <h3 style="color: #6366f1; font-size: 1.5rem; font-weight: bold; margin-bottom: 10px;">STANDARD</h3>
                        <p style="color: white; font-size: 2.5rem; font-weight: extrabold; margin-bottom: 15px;">$4.99<span style="font-size: 1rem;">/–º–µ—Å</span></p>
                        <ul style="list-style: none; padding: 0; margin-bottom: 20px; color: #d1d5db; text-align: left;">
                            <li style="margin-bottom: 8px;">üöÄ 20 –±—ç–∫—Ç–µ—Å—Ç–æ–≤ –≤ –¥–µ–Ω—å</li>
                            <li style="margin-bottom: 8px;">‚úÖ –î–æ—Å—Ç—É–ø –∫ EMA Crossover</li>
                            <li style="margin-bottom: 8px;">‚ùå –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è / –û–ø—Ü–∏–æ–Ω—ã</li>
                        </ul>
                        <button style="width: 100%; padding: 10px; background-color: #6366f1; color: white; font-weight: bold; border-radius: 8px;">Upgrade Now</button>
                    </div>

                    <div style="flex: 1; background-color: #1f2937; padding: 25px; border-radius: 12px; border: 2px solid #a855f7;">
                        <h3 style="color: #a855f7; font-size: 1.5rem; font-weight: bold; margin-bottom: 10px;">PRO</h3>
                        <p style="color: white; font-size: 2.5rem; font-weight: extrabold; margin-bottom: 15px;">$19.99<span style="font-size: 1rem;">/–º–µ—Å</span></p>
                        <ul style="list-style: none; padding: 0; margin-bottom: 20px; color: #d1d5db; text-align: left;">
                            <li style="margin-bottom: 8px;">‚ôæÔ∏è –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</li>
                            <li style="margin-bottom: 8px;">‚ú® **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**</li>
                            <li style="margin-bottom: 8px;">üíª **–°–≤–æ–π –ö–æ–¥ –°—Ç—Ä–∞—Ç–µ–≥–∏–∏**</li>
                        </ul>
                        <button style="width: 100%; padding: 10px; background-color: #a855f7; color: white; font-weight: bold; border-radius: 8px;">Upgrade Now</button>
                    </div>
                </div>

                <div class="text-center mt-6">
                    <a href="#" class="text-blue-400 hover:text-blue-300" onclick="window.toggleModal('subscriptionModal'); window.toggleModal('pricingPageModal');" data-i18n="view_all_plans">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –ø–ª–∞–Ω—ã (–≤–∫–ª—é—á–∞—è ULTRA)</a>
                </div>

                <button onclick="window.toggleModal('subscriptionModal')" class="btn-secondary w-full mt-6 py-2 rounded-lg" data-i18n="close_button">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>

        <div id="accountModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
            <div class="card max-w-lg w-full">
                <h2 class="text-2xl font-bold mb-4 text-accent" data-i18n="account_details_title">–î–µ—Ç–∞–ª–∏ –ê–∫–∫–∞—É–Ω—Ç–∞</h2>
                <div class="space-y-4">
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <p class="text-sm text-gray-400" data-i18n="logged_in_as">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ (ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Firebase):</p>
                        <p id="accountUserId" class="font-mono break-all text-sm text-gray-100">Loading...</p>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <p class="text-sm text-gray-400" data-i18n="current_tier_display">–¢–µ–∫—É—â–∏–π –¢–∞—Ä–∏—Ñ–Ω—ã–π –ü–ª–∞–Ω:</p>
                        <p id="accountTier" class="text-xl font-bold text-red-400">Loading...</p>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <p class="text-sm text-gray-400" data-i18n="daily_resets_at">–°—á–µ—Ç—á–∏–∫ —Ç–µ—Å—Ç–æ–≤ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ –ø–æ–ª–Ω–æ—á—å –ø–æ UTC.</p>
                    </div>
                </div>
                <button onclick="window.toggleModal('accountModal')" class="btn-secondary w-full mt-6 py-2 rounded-lg" data-i18n="close_button">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>

        <div id="pricingPageModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden overflow-y-auto flex justify-center p-4 z-50">
            <div class="card max-w-5xl w-full my-8">
                <button onclick="window.toggleModal('pricingPageModal')" class="float-right text-gray-400 hover:text-gray-100 text-3xl">&times;</button>
                <div id="pricingContent">
                    </div>
                <button onclick="window.toggleModal('pricingPageModal')" class="btn-secondary w-full mt-6 py-2 rounded-lg" data-i18n="close_button">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï FIREBASE (–¢–µ–ø–µ—Ä—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏)
        const __app_id = '1:530996092270:web:1996a841416cc556c1ef57f'; // –í–∞—à —Ä–µ–∞–ª—å–Ω—ã–π appId
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyBpXKHkHL0pNiI8qem-YD8IHbVmuNBP4",
            authDomain: "algovizor-prod.firebaseapp.com",
            projectId: "algovizor-prod",
            storageBucket: "algovizor-prod.appspot.com",
            messagingSenderId: "530996092270",
            appId: "1:530996092270:web:1996a841416cc556c1ef57f",
            measurementId: "G-4VMHSWF98N"
        });
        const __initial_auth_token = null;

        // --- FIREBASE IMPORTS (–¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞, –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ) ---
        // –≠—Ç–∏ URLS –º—ã –±–µ—Ä–µ–º –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Firebase SDK
        const FIREBASE_APP_URL = "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        const FIREBASE_AUTH_URL = "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        const FIREBASE_FIRESTORE_URL = "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
        const loadScript = (url) => {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = url;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        };

        let initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot;
        let app, db, auth;

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è –∂–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
        async function initializeFirebase() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
                await loadScript(FIREBASE_APP_URL);
                await loadScript(FIREBASE_AUTH_URL);
                await loadScript(FIREBASE_FIRESTORE_URL);

                // –ü–æ–ª—É—á–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
                // (–≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã –≤ window.firebase –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ SDK)
                initializeApp = window.firebase.initializeApp;
                getAuth = window.firebase.auth.getAuth;
                signInAnonymously = window.firebase.auth.signInAnonymously;
                onAuthStateChanged = window.firebase.auth.onAuthStateChanged;
                getFirestore = window.firebase.firestore.getFirestore;
                doc = window.firebase.firestore.doc;
                getDoc = window.firebase.firestore.getDoc;
                setDoc = window.firebase.firestore.setDoc;
                updateDoc = window.firebase.firestore.updateDoc;
                onSnapshot = window.firebase.firestore.onSnapshot;


                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (!firebaseConfig) {
                    console.error("Firebase configuration is missing.");
                    document.getElementById('statusMessage').textContent = "ERROR: Firebase config missing.";
                }

                app = firebaseConfig ? initializeApp(firebaseConfig) : null;
                db = app ? getFirestore(app) : null;
                auth = app ? getAuth(app) : null;

                window.db = db;
                window.auth = auth;
                window.appId = appId;
                window.currentUserId = null;
                window.userTier = 'FREE'; // Default
                window.maxTests = 3;

                // --- –ó–∞–ø—É—Å–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase ---
                if (auth) {
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            window.currentUserId = user.uid;
                            document.getElementById('userIdDisplay').textContent = user.uid.substring(0, 10) + '...';
                            document.getElementById('accountUserId').textContent = user.uid;
                            setupUserListener(user.uid);
                        } else {
                            signInAnonymously(auth).then(cred => {
                                window.currentUserId = cred.user.uid;
                                document.getElementById('userIdDisplay').textContent = cred.user.uid.substring(0, 10) + '...';
                                document.getElementById('accountUserId').textContent = cred.user.uid;
                                setupUserListener(cred.user.uid);
                            }).catch(error => {
                                console.error("Anonymous Sign-in Error:", error);
                                document.getElementById('statusMessage').textContent = "ERROR: Anonymous sign-in failed.";
                            });
                        }
                    });
                } else {
                    // –ï—Å–ª–∏ Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–∏–º–∏—Ç—ã FREE –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    updateUIBasedOnTier('FREE', 0);
                    document.getElementById('userIdDisplay').textContent = "LOCAL_USER";
                    document.getElementById('accountUserId').textContent = "LOCAL_USER";
                }

            } catch (error) {
                console.error("Fatal Firebase Initialization Error:", error);
                document.getElementById('statusMessage').textContent = "ERROR: Could not load Firebase SDKs. Check your network or configuration.";
            }

            // --- –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ UI –ø–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase ---
            window.setLanguage('ru');
            window.initDatePickers();
            window.loadPricingContent();
        }

        // Utility to get the user-specific document path
        const getUserDocRef = (userId) => {
            if (!db || typeof doc === 'undefined') return null; // –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è DB
            return doc(db, `artifacts/${appId}/users/${userId}/