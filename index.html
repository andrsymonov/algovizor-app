<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlgoVizor - Backtesting & Optimization</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>

    <style>
        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            max-height: 400px;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Dark mode aesthetics for inputs and textarea */
        input[type="text"], input[type="number"], input[type="date"], select, textarea {
            background-color: #374151; /* gray-700 */
            border: 1px solid #4b5563; /* gray-600 */
            color: #d1d5db; /* gray-300 */
            padding: 8px 12px;
            border-radius: 6px;
            width: 100%;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus, textarea:focus {
            border-color: #3b82f6; /* blue-500 */
            outline: none;
        }

        .card {
            background-color: #1f2937; /* gray-800 */
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            padding: 24px;
        }

        .text-accent {
            color: #f59e0b; /* Amber for accents */
        }

        .btn-primary {
            background-color: #10b981; /* Emerald for positive action */
            color: #1f2937;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #059669;
        }

        .btn-secondary {
            background-color: #374151;
            color: #d1d5db;
            border: 1px solid #4b5563;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .nav-item {
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .nav-item:hover {
            background-color: #374151;
        }

        .active-nav {
            background-color: #4b5563;
            color: white;
            font-weight: bold;
        }

        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Position above the tooltip container */
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-4 md:p-8">
        <header class="flex flex-col md:flex-row justify-between items-center py-4 border-b border-gray-700 mb-6">
            <h1 class="text-3xl font-extrabold text-accent">AlgoVizor<span class="text-gray-400 text-xl font-light ml-2">Beta</span></h1>
            <div class="flex items-center space-x-4 mt-4 md:mt-0">
                <div class="flex items-center space-x-2">
                    <label for="lang-select" class="text-sm" data-i18n="language_label">Language:</label>
                    <select id="lang-select" class="bg-gray-800 border border-gray-700 text-gray-100 rounded-md p-1 text-sm" onchange="window.setLanguage(this.value)">
                        <option value="en">English</option>
                        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                    </select>
                </div>
                <button id="accountButton" onclick="window.toggleModal('accountModal')" class="btn-secondary px-4 py-2 rounded-lg text-sm" data-i18n="account_button">Account</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <aside class="lg:col-span-1 space-y-6">
                <div id="statusCard" class="card">
                    <h2 class="text-xl font-semibold mb-3 text-accent" data-i18n="status_title">User Status</h2>
                    <div class="flex justify-between mb-2">
                        <span data-i18n="user_id_label">User ID:</span>
                        <span id="userIdDisplay" class="truncate text-sm text-gray-400" title="">Loading...</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span data-i18n="tier_label">Subscription Tier:</span>
                        <span id="tierDisplay" class="font-bold text-lg text-red-400">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span data-i18n="tests_remaining_label">Tests Remaining:</span>
                        <span id="testsUsedDisplay" class="font-bold text-lg">Loading...</span>
                    </div>
                    <button onclick="window.toggleModal('subscriptionModal')" class="btn-secondary w-full mt-4 py-2 rounded-lg" data-i18n="upgrade_button">Upgrade Plan</button>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-accent" data-i18n="backtest_params_title">Backtest Parameters</h2>

                    <label for="ticker" class="block mb-1 text-sm font-medium" data-i18n="ticker_label">Ticker (e.g., AAPL):</label>
                    <input type="text" id="ticker" value="AAPL" class="mb-3">

                    <label for="timeframe" class="block mb-1 text-sm font-medium" data-i18n="timeframe_label">Timeframe:</label>
                    <select id="timeframe" class="mb-3">
                        <option value="60min">60 min (1 hour)</option>
                        <option value="30min">30 min</option>
                        <option value="4h">4 hours</option>
                        <option value="Daily">Daily (1 day)</option>
                    </select>

                    <label for="strategySelect" class="block mb-1 text-sm font-medium" data-i18n="strategy_label">Strategy:</label>
                    <select id="strategySelect" onchange="window.toggleStrategyInput()" class="mb-3">
                        <option value="ema_crossover">EMA Crossover (Default)</option>
                        <option value="custom_code" disabled data-i18n="custom_code_option">(PRO) Custom Code</option>
                    </select>

                    <div id="emaParams" class="space-y-3 mt-3">
                        <h3 class="font-medium text-gray-400" data-i18n="ema_params_title">EMA Crossover Settings:</h3>
                        <label for="fastEMA" class="block text-sm">Fast EMA (e.g., 50):</label>
                        <input type="number" id="fastEMA" value="50" min="1" class="w-full">
                        <label for="slowEMA" class="block text-sm">Slow EMA (e.g., 200):</label>
                        <input type="number" id="slowEMA" value="200" min="1" class="w-full">
                    </div>

                    <div id="customCode" class="space-y-3 mt-3 hidden">
                        <h3 class="font-medium text-gray-400" data-i18n="custom_code_area_title">Custom Strategy Code (PRO):</h3>
                        <textarea id="customCodeArea" rows="6" class="w-full text-xs font-mono" placeholder="function entryCondition(data, index) { /* your logic */ return data.fastEMA[index] > data.slowEMA[index]; }"></textarea>
                    </div>

                    <h3 class="font-medium text-gray-400 mt-4 mb-2" data-i18n="date_range_title">Date Range:</h3>
                    <label for="startDate" class="block text-sm" data-i18n="start_date_label">Start Date:</label>
                    <input type="date" id="startDate" class="w-full mb-3">
                    <label for="endDate" class="block text-sm" data-i18n="end_date_label">End Date:</label>
                    <input type="date" id="endDate" class="w-full">
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-accent" data-i18n="telegram_alerts_title">Telegram Alerts</h2>
                    <p class="text-sm text-gray-400 mb-3" data-i18n="telegram_info">Receive instant signals (Buy/Sell) to your Telegram chat.</p>

                    <label for="telegramChatId" class="block mb-1 text-sm font-medium">Chat ID:</label>
                    <input type="text" id="telegramChatId" placeholder="Your Telegram Chat ID" class="mb-3">

                    <label for="telegramToken" class="block mb-1 text-sm font-medium">Bot API Token:</label>
                    <input type="text" id="telegramToken" placeholder="Your Bot Token" class="mb-3">

                    <button id="sendSignalButton" onclick="window.sendTelegramSignal('Test', 'Test message from AlgoVizor')" class="btn-secondary w-full py-2 rounded-lg text-sm" data-i18n="send_test_signal">Send Test Signal</button>
                </div>

                <div class="card bg-gray-800 p-4 rounded-lg">
                    <div id="statusMessage" class="text-sm text-yellow-500" data-i18n="status_initial">Enter parameters and run Backtest.</div>
                </div>
            </aside>

            <main class="lg:col-span-3 space-y-6">
                <div class="flex flex-col md:flex-row justify-between space-y-4 md:space-y-0 md:space-x-4">
                    <button id="runBacktestButton" onclick="window.runBacktest()" class="btn-primary flex-1 py-3 rounded-lg text-lg">
                        <span data-i18n="run_backtest_button">Run Backtest</span> (<span id="backtestCostDisplay">1</span> <span data-i18n="test_cost_label">Test</span>)
                    </button>
                    <button id="runOptimizationButton" onclick="window.toggleModal('optimizationModal')" class="btn-secondary flex-1 py-3 rounded-lg text-lg" disabled>
                        <span data-i18n="run_optimization_button">Run Optimization</span> (PRO)
                    </button>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-accent" data-i18n="chart_title">Price & Equity Chart</h2>
                    <div id="chartLoading" class="hidden text-center py-10">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent mx-auto mb-4"></div>
                        <p data-i18n="loading_data">Loading and calculating data...</p>
                    </div>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>

                <div class="card grid grid-cols-1 md:grid-cols-3 gap-4">
                    <h2 class="col-span-full text-xl font-semibold mb-2 text-accent" data-i18n="results_title">Backtest Results</h2>
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <p class="text-sm text-gray-400" data-i18n="net_return_label">Net Return:</p>
                        <p id="netReturn" class="text-2xl font-bold text-gray-100">--</p>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <p class="text-sm text-gray-400" data-i18n="max_drawdown_label">Max Drawdown:</p>
                        <p id="maxDrawdown" class="text-2xl font-bold text-gray-100">--</p>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <p class="text-sm text-gray-400" data-i18n="trades_label">Total Trades:</p>
                        <p id="totalTrades" class="text-2xl font-bold text-gray-100">--</p>
                    </div>
                </div>
            </main>
        </div>

        <div id="optimizationModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
            <div class="card max-w-2xl w-full">
                <h2 class="text-2xl font-bold mb-4 text-accent" data-i18n="optimization_modal_title">Strategy Optimization (PRO)</h2>
                <p class="mb-6 text-gray-300" data-i18n="optimization_info">Set the range and step size. The system will test all combinations to find the top 3 results based on Net Return.</p>

                <h3 class="text-lg font-semibold mb-3" data-i18n="optimization_range_title">Optimization Range:</h3>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="col-span-1">
                        <label class="block text-sm font-medium mb-1" data-i18n="fast_ema_min">Fast EMA Min:</label>
                        <input type="number" id="optFastMin" value="10" min="1">
                    </div>
                    <div class="col-span-1">
                        <label class="block text-sm font-medium mb-1" data-i18n="fast_ema_max">Fast EMA Max:</label>
                        <input type="number" id="optFastMax" value="60" min="1">
                    </div>
                    <div class="col-span-1">
                        <label class="block text-sm font-medium mb-1" data-i18n="opt_step">Step:</label>
                        <input type="number" id="optStep" value="10" min="1">
                    </div>

                    <div class="col-span-1">
                        <label class="block text-sm font-medium mb-1" data-i18n="slow_ema_min">Slow EMA Min:</label>
                        <input type="number" id="optSlowMin" value="100" min="1">
                    </div>
                    <div class="col-span-1">
                        <label class="block text-sm font-medium mb-1" data-i18n="slow_ema_max">Slow EMA Max:</label>
                        <input type="number" id="optSlowMax" value="300" min="1">
                    </div>
                    <div class="col-span-1">
                        <label class="block text-sm font-medium mb-1" data-i18n="opt_step_filler">Step:</label>
                        <input type="number" value="50" disabled class="bg-gray-700 opacity-50">
                    </div>
                </div>

                <button id="startOptimizationButton" onclick="window.runOptimization()" class="btn-primary w-full py-3 rounded-lg text-lg mb-4" data-i18n="start_optimization">Start Optimization</button>

                <div id="optimizationLoading" class="hidden text-center py-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-accent mx-auto mb-2"></div>
                    <p data-i18n="optimizing_status">Running combinations...</p>
                </div>

                <h3 class="text-lg font-semibold mb-3 mt-4 text-accent" data-i18n="top_results_title">Top 3 Results:</h3>
                <ul id="optimizationResults" class="space-y-2 text-gray-300">
                    <li data-i18n="optimization_placeholder">Run optimization to see results.</li>
                </ul>

                <button onclick="window.toggleModal('optimizationModal')" class="btn-secondary w-full mt-6 py-2 rounded-lg" data-i18n="close_button">Close</button>
            </div>
        </div>

        <div id="subscriptionModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
            <div class="card max-w-3xl w-full">
                <h2 class="text-2xl font-bold mb-4 text-accent" data-i18n="subscription_modal_title">Upgrade Your Plan</h2>
                <p id="subscriptionMessage" class="mb-6 text-lg text-gray-300">You have reached your daily limit of 3 free tests.</p>

                <div style="display: flex; gap: 20px; text-align: center; margin-top: 20px;">
                    <div style="flex: 1; background-color: #1f2937; padding: 25px; border-radius: 12px; border: 2px solid #10b981;">
                        <h3 style="color: #10b981; font-size: 1.5rem; font-weight: bold; margin-bottom: 10px;">FREE</h3>
                        <p style="color: white; font-size: 2.5rem; font-weight: extrabold; margin-bottom: 15px;">$0</p>
                        <ul style="list-style: none; padding: 0; margin-bottom: 20px; color: #d1d5db; text-align: left;">
                            <li style="margin-bottom: 8px;">‚úÖ 3 –±—ç–∫—Ç–µ—Å—Ç–∞ –≤ –¥–µ–Ω—å</li>
                            <li style="margin-bottom: 8px;">‚úÖ –î–æ—Å—Ç—É–ø –∫ EMA Crossover</li>
                            <li style="margin-bottom: 8px;">‚ùå –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è / –û–ø—Ü–∏–æ–Ω—ã</li>
                        </ul>
                        <button style="width: 100%; padding: 10px; background-color: #34d399; color: black; font-weight: bold; border-radius: 8px; cursor: default;">Current Plan</button>
                    </div>

                    <div style="flex: 1; background-color: #1f2937; padding: 25px; border-radius: 12px; border: 2px solid #6366f1;">
                        <h3 style="color: #6366f1; font-size: 1.5rem; font-weight: bold; margin-bottom: 10px;">STANDARD</h3>
                        <p style="color: white; font-size: 2.5rem; font-weight: extrabold; margin-bottom: 15px;">$4.99<span style="font-size: 1rem;">/–º–µ—Å</span></p>
                        <ul style="list-style: none; padding: 0; margin-bottom: 20px; color: #d1d5db; text-align: left;">
                            <li style="margin-bottom: 8px;">üöÄ 20 –±—ç–∫—Ç–µ—Å—Ç–æ–≤ –≤ –¥–µ–Ω—å</li>
                            <li style="margin-bottom: 8px;">‚úÖ –î–æ—Å—Ç—É–ø –∫ EMA Crossover</li>
                            <li style="margin-bottom: 8px;">‚ùå –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è / –û–ø—Ü–∏–æ–Ω—ã</li>
                        </ul>
                        <button style="width: 100%; padding: 10px; background-color: #6366f1; color: white; font-weight: bold; border-radius: 8px;">Upgrade Now</button>
                    </div>

                    <div style="flex: 1; background-color: #1f2937; padding: 25px; border-radius: 12px; border: 2px solid #a855f7;">
                        <h3 style="color: #a855f7; font-size: 1.5rem; font-weight: bold; margin-bottom: 10px;">PRO</h3>
                        <p style="color: white; font-size: 2.5rem; font-weight: extrabold; margin-bottom: 15px;">$19.99<span style="font-size: 1rem;">/–º–µ—Å</span></p>
                        <ul style="list-style: none; padding: 0; margin-bottom: 20px; color: #d1d5db; text-align: left;">
                            <li style="margin-bottom: 8px;">‚ôæÔ∏è –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</li>
                            <li style="margin-bottom: 8px;">‚ú® **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**</li>
                            <li style="margin-bottom: 8px;">üíª **–°–≤–æ–π –ö–æ–¥ –°—Ç—Ä–∞—Ç–µ–≥–∏–∏**</li>
                        </ul>
                        <button style="width: 100%; padding: 10px; background-color: #a855f7; color: white; font-weight: bold; border-radius: 8px;">Upgrade Now</button>
                    </div>
                </div>

                <div class="text-center mt-6">
                    <a href="#" class="text-blue-400 hover:text-blue-300" onclick="window.toggleModal('subscriptionModal'); window.toggleModal('pricingPageModal');" data-i18n="view_all_plans">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –ø–ª–∞–Ω—ã (–≤–∫–ª—é—á–∞—è ULTRA)</a>
                </div>

                <button onclick="window.toggleModal('subscriptionModal')" class="btn-secondary w-full mt-6 py-2 rounded-lg" data-i18n="close_button">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>

        <div id="accountModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
            <div class="card max-w-lg w-full">
                <h2 class="text-2xl font-bold mb-4 text-accent" data-i18n="account_details_title">–î–µ—Ç–∞–ª–∏ –ê–∫–∫–∞—É–Ω—Ç–∞</h2>
                <div class="space-y-4">
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <p class="text-sm text-gray-400" data-i18n="logged_in_as">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ (ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Firebase):</p>
                        <p id="accountUserId" class="font-mono break-all text-sm text-gray-100">Loading...</p>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <p class="text-sm text-gray-400" data-i18n="current_tier_display">–¢–µ–∫—É—â–∏–π –¢–∞—Ä–∏—Ñ–Ω—ã–π –ü–ª–∞–Ω:</p>
                        <p id="accountTier" class="text-xl font-bold text-red-400">Loading...</p>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <p class="text-sm text-gray-400" data-i18n="daily_resets_at">–°—á–µ—Ç—á–∏–∫ —Ç–µ—Å—Ç–æ–≤ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ –ø–æ–ª–Ω–æ—á—å –ø–æ UTC.</p>
                    </div>
                </div>
                <button onclick="window.toggleModal('accountModal')" class="btn-secondary w-full mt-6 py-2 rounded-lg" data-i18n="close_button">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>

        <div id="pricingPageModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden overflow-y-auto flex justify-center p-4 z-50">
            <div class="card max-w-5xl w-full my-8">
                <button onclick="window.toggleModal('pricingPageModal')" class="float-right text-gray-400 hover:text-gray-100 text-3xl">&times;</button>
                <div id="pricingContent">
                    </div>
                <button onclick="window.toggleModal('pricingPageModal')" class="btn-secondary w-full mt-6 py-2 rounded-lg" data-i18n="close_button">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï FIREBASE (–¢–µ–ø–µ—Ä—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏)
        const __app_id = '1:530996092270:web:1996a841416cc556c1ef57f'; // –í–∞—à —Ä–µ–∞–ª—å–Ω—ã–π appId
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyBpXKHkHL0pNiI8qem-YD8IHbVmuNBP4",
            authDomain: "algovizor-prod.firebaseapp.com",
            projectId: "algovizor-prod",
            storageBucket: "algovizor-prod.appspot.com",
            messagingSenderId: "530996092270",
            appId: "1:530996092270:web:1996a841416cc556c1ef57f",
            measurementId: "G-4VMHSWF98N"
        });
        const __initial_auth_token = null;

        // --- –í–°–ï –§–£–ù–ö–¶–ò–ò –ò –õ–û–ì–ò–ö–ê –û–ü–†–ï–î–ï–õ–Ø–Æ–¢–°–Ø –ó–î–ï–°–¨ ---

        let app, db, auth;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase, –∏—Å–ø–æ–ª—å–∑—É—è –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –≤ <head>
        // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º document.addEventListener('DOMContentLoaded') –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —ç—Ç–æ–π –ª–æ–≥–∏–∫–∏
        function initializeAppAndAuth() {
            
            if (typeof firebase === 'undefined' || typeof firebase.initializeApp === 'undefined') {
                console.error("CRITICAL: Firebase SDK not loaded in <head>. Cannot initialize.");
                window.updateUIBasedOnTier('FREE', 0); // Fallback
                return;
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è App, DB, Auth
            window.app = firebaseConfig ? firebase.initializeApp(firebaseConfig) : null;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º–æ–¥—É–ª–∏ Firestore/Auth –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ App
            if (window.app) {
                if (typeof window.app.firestore === 'function') {
                    window.db = window.app.firestore();
                }
                if (typeof window.app.auth === 'function') {
                    window.auth = window.app.auth();
                }
            }

            window.db = window.db || null;
            window.auth = window.auth || null;
            window.appId = appId;
            window.currentUserId = null;
            window.userTier = 'FREE'; // Default
            window.maxTests = 3;

            // --- –ó–∞–ø—É—Å–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ ---
            if (window.auth && typeof window.auth.onAuthStateChanged === 'function') {
                window.auth.onAuthStateChanged((user) => {
                    if (user) {
                        window.currentUserId = user.uid;
                        document.getElementById('userIdDisplay').textContent = user.uid.substring(0, 10) + '...';
                        document.getElementById('accountUserId').textContent = user.uid;
                        setupUserListener(user.uid);
                    } else {
                        window.auth.signInAnonymously().then(cred => {
                            window.currentUserId = cred.user.uid;
                            document.getElementById('userIdDisplay').textContent = cred.user.uid.substring(0, 10) + '...';
                            document.getElementById('accountUserId').textContent = cred.user.uid;
                            setupUserListener(cred.user.uid);
                        }).catch(error => {
                            console.error("Anonymous Sign-in Error:", error);
                            document.getElementById('statusMessage').textContent = "ERROR: Anonymous sign-in failed.";
                        });
                    }
                });
            } else {
                 // –ï—Å–ª–∏ Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–∏–º–∏—Ç—ã FREE –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                 window.updateUIBasedOnTier('FREE', 0);
                 document.getElementById('userIdDisplay').textContent = "LOCAL_USER";
                 document.getElementById('accountUserId').textContent = "LOCAL_USER";
            }
        }


        // Utility to get the user-specific document path
        const getUserDocRef = (userId) => {
            if (!window.db) return null;
            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ v8 —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –¥–ª—è Firestore
            return window.db.collection('artifacts').doc(window.appId).collection('users').doc(userId).collection('limits').doc('daily_usage');
        };

        // --- TRANSLATIONS (i18n) ---
        window.translations = {
            en: {
                language_label: "Language:",
                account_button: "Account",
                status_title: "User Status",
                user_id_label: "User ID:",
                tier_label: "Subscription Tier:",
                tests_remaining_label: "Tests Remaining:",
                upgrade_button: "Upgrade Plan",
                backtest_params_title: "Backtest Parameters",
                ticker_label: "Ticker (e.g., AAPL):",
                timeframe_label: "Timeframe:",
                strategy_label: "Strategy:",
                custom_code_option: "(PRO) Custom Code",
                ema_params_title: "EMA Crossover Settings:",
                date_range_title: "Date Range:",
                start_date_label: "Start Date:",
                end_date_label: "End Date:",
                telegram_alerts_title: "Telegram Alerts",
                telegram_info: "Receive instant signals (Buy/Sell) to your Telegram chat.",
                send_test_signal: "Send Test Signal",
                status_initial: "Enter parameters and run Backtest.",
                run_backtest_button: "Run Backtest",
                test_cost_label: "Test",
                run_optimization_button: "Run Optimization",
                chart_title: "Price & Equity Chart",
                loading_data: "Loading and calculating data...",
                results_title: "Backtest Results",
                net_return_label: "Net Return:",
                max_drawdown_label: "Max Drawdown:",
                trades_label: "Total Trades:",
                optimization_modal_title: "Strategy Optimization (PRO)",
                optimization_info: "Set the range and step size. The system will test all combinations to find the top 3 results based on Net Return.",
                optimization_range_title: "Optimization Range:",
                fast_ema_min: "Fast EMA Min:",
                fast_ema_max: "Fast EMA Max:",
                opt_step: "Step:",
                slow_ema_min: "Slow EMA Min:",
                slow_ema_max: "Slow EMA Max:",
                opt_step_filler: "Step:",
                start_optimization: "Start Optimization",
                optimizing_status: "Running combinations...",
                top_results_title: "Top 3 Results:",
                optimization_placeholder: "Run optimization to see results.",
                close_button: "Close",
                subscription_modal_title: "Upgrade Your Plan",
                subscription_message_limit: "You have reached your daily limit of {limit} free tests.",
                subscription_message_pro: "Your current {tier} plan gives you {limit} tests per day.",
                account_details_title: "Account Details",
                logged_in_as: "Logged in as (Firebase User ID):",
                current_tier_display: "Current Subscription Tier:",
                daily_resets_at: "Daily test count resets at midnight UTC.",
                view_all_plans: "View All Plans (ULTRA included)",
                api_error: "API Error. Check Ticker, Timeframe, or API Key.",
                limit_exceeded: "Daily test limit exceeded. Please upgrade.",
                custom_code_disabled: "(PRO required) Custom Code is disabled.",
                optimization_disabled: "Optimization is only available for PRO/ULTRA plans.",
                telegram_error: "Telegram send error: Check Chat ID and Token.",
                telegram_success: "Test signal sent successfully!",
                telegram_buy: "BUY Signal for {ticker}!",
                telegram_sell: "SELL Signal for {ticker}!",
            },
            ru: {
                language_label: "–Ø–∑—ã–∫:",
                account_button: "–ê–∫–∫–∞—É–Ω—Ç",
                status_title: "–°—Ç–∞—Ç—É—Å –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
                user_id_label: "ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:",
                tier_label: "–¢–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω:",
                tests_remaining_label: "–û—Å—Ç–∞–ª–æ—Å—å —Ç–µ—Å—Ç–æ–≤:",
                upgrade_button: "–û–±–Ω–æ–≤–∏—Ç—å –¢–∞—Ä–∏—Ñ",
                backtest_params_title: "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ë—ç–∫—Ç–µ—Å—Ç–∞",
                ticker_label: "–¢–∏–∫–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, AAPL):",
                timeframe_label: "–¢–∞–π–º—Ñ—Ä–µ–π–º:",
                strategy_label: "–°—Ç—Ä–∞—Ç–µ–≥–∏—è:",
                custom_code_option: "(PRO) –ö–∞—Å—Ç–æ–º–Ω—ã–π –ö–æ–¥",
                ema_params_title: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ EMA Crossover:",
                date_range_title: "–í—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω:",
                start_date_label: "–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:",
                end_date_label: "–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:",
                telegram_alerts_title: "Telegram –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
                telegram_info: "–ü–æ–ª—É—á–∞–π—Ç–µ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã (–ü–æ–∫—É–ø–∫–∞/–ü—Ä–æ–¥–∞–∂–∞) –≤ —Å–≤–æ–π —á–∞—Ç Telegram.",
                send_test_signal: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª",
                status_initial: "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ë—ç–∫—Ç–µ—Å—Ç.",
                run_backtest_button: "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ë—ç–∫—Ç–µ—Å—Ç",
                test_cost_label: "–¢–µ—Å—Ç",
                run_optimization_button: "–ó–∞–ø—É—Å—Ç–∏—Ç—å –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é",
                chart_title: "–ì—Ä–∞—Ñ–∏–∫ –¶–µ–Ω—ã –∏ –ö–∞–ø–∏—Ç–∞–ª–∞",
                loading_data: "–ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–∞—Å—á–µ—Ç –¥–∞–Ω–Ω—ã—Ö...",
                results_title: "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ë—ç–∫—Ç–µ—Å—Ç–∞",
                net_return_label: "–ß–∏—Å—Ç–∞—è –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å:",
                max_drawdown_label: "–ú–∞–∫—Å. –ü—Ä–æ—Å–∞–¥–∫–∞:",
                trades_label: "–í—Å–µ–≥–æ –°–¥–µ–ª–æ–∫:",
                optimization_modal_title: "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ (PRO)",
                optimization_info: "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω –∏ —à–∞–≥. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –≤—Å–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –∏ –Ω–∞–π–¥–µ—Ç —Ç–æ–ø-3 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ —á–∏—Å—Ç–æ–π –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏.",
                optimization_range_title: "–î–∏–∞–ø–∞–∑–æ–Ω –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:",
                fast_ema_min: "–ë—ã—Å—Ç—Ä–∞—è EMA –ú–∏–Ω:",
                fast_ema_max: "–ë—ã—Å—Ç—Ä–∞—è EMA –ú–∞–∫—Å:",
                opt_step: "–®–∞–≥:",
                slow_ema_min: "–ú–µ–¥–ª–µ–Ω–Ω–∞—è EMA –ú–∏–Ω:",
                slow_ema_max: "–ú–µ–¥–ª–µ–Ω–Ω–∞—è EMA –ú–∞–∫—Å:",
                opt_step_filler: "–®–∞–≥:",
                start_optimization: "–ù–∞—á–∞—Ç—å –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é",
                optimizing_status: "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π...",
                top_results_title: "–¢–æ–ø-3 –†–µ–∑—É–ª—å—Ç–∞—Ç–∞:",
                optimization_placeholder: "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.",
                close_button: "–ó–∞–∫—Ä—ã—Ç—å",
                subscription_modal_title: "–û–±–Ω–æ–≤–∏—Ç—å –í–∞—à –ü–ª–∞–Ω",
                subscription_message_limit: "–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –¥–Ω–µ–≤–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ –≤ {limit} –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤.",
                subscription_message_pro: "–í–∞—à —Ç–µ–∫—É—â–∏–π –ø–ª–∞–Ω {tier} –¥–∞–µ—Ç –≤–∞–º {limit} —Ç–µ—Å—Ç–æ–≤ –≤ –¥–µ–Ω—å.",
                account_details_title: "–î–µ—Ç–∞–ª–∏ –ê–∫–∫–∞—É–Ω—Ç–∞",
                logged_in_as: "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ (ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Firebase):",
                current_tier_display: "–¢–µ–∫—É—â–∏–π –¢–∞—Ä–∏—Ñ–Ω—ã–π –ü–ª–∞–Ω:",
                daily_resets_at: "–°—á–µ—Ç—á–∏–∫ —Ç–µ—Å—Ç–æ–≤ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ –ø–æ–ª–Ω–æ—á—å –ø–æ UTC.",
                view_all_plans: "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –ø–ª–∞–Ω—ã (–≤–∫–ª—é—á–∞—è ULTRA)",
                api_error: "–û—à–∏–±–∫–∞ API. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¢–∏–∫–µ—Ä, –¢–∞–π–º—Ñ—Ä–µ–π–º –∏–ª–∏ API –ö–ª—é—á.",
                limit_exceeded: "–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç —Ç–µ—Å—Ç–æ–≤ –ø—Ä–µ–≤—ã—à–µ–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Ç–∞—Ä–∏—Ñ.",
                custom_code_disabled: "(–¢—Ä–µ–±—É–µ—Ç—Å—è PRO) –ö–∞—Å—Ç–æ–º–Ω—ã–π –∫–æ–¥ –æ—Ç–∫–ª—é—á–µ–Ω.",
                optimization_disabled: "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–ª–∞–Ω–æ–≤ PRO/ULTRA.",
                telegram_error: "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ Telegram: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Chat ID –∏ –¢–æ–∫–µ–Ω.",
                telegram_success: "–¢–µ—Å—Ç–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!",
                telegram_buy: "–°–∏–≥–Ω–∞–ª –ü–û–ö–£–ü–ö–ê –¥–ª—è {ticker}!",
                telegram_sell: "–°–∏–≥–Ω–∞–ª –ü–†–û–î–ê–ñ–ê –¥–ª—è {ticker}!",
            }
        };

        window.setLanguage = (lang) => {
            window.currentLang = lang;
            const elements = document.querySelectorAll('[data-i18n]');
            const T = window.translations[lang];
            elements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (T[key]) {
                    el.textContent = T[key];
                }
            });

            // Update disabled option text
            const customCodeOption = document.getElementById('strategySelect').querySelector('option[value="custom_code"]');
            if (customCodeOption) {
                customCodeOption.textContent = T['custom_code_option'];
            }
            // Update Chart labels if it exists
            if (window.priceChart) {
                window.priceChart.options.scales.y.title.text = T['chart_title_y_axis'] || 'Price / Equity';
                window.priceChart.update();
            }
        };

        window.setupUserListener = (userId) => {
            if (!window.auth || !window.db || typeof window.db.getDoc === 'undefined') {
                 document.getElementById('statusMessage').textContent = "INFO: Firebase is not fully initialized. Using default FREE limits.";
                 return;
            }
            const userDocRef = getUserDocRef(userId);
            if (!userDocRef) return; // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

            // Initial check and setup if document doesn't exist
            window.db.collection('artifacts').doc(window.appId).collection('users').doc(userId).collection('limits').doc('daily_usage').get().then(docSnap => {
                if (!docSnap.exists) {
                    // Initialize the document for a new user
                    const initialData = {
                        tier: 'FREE',
                        testsUsed: 0,
                        lastReset: new Date().toISOString()
                    };
                    return window.db.collection('artifacts').doc(window.appId).collection('users').doc(userId).collection('limits').doc('daily_usage').set(initialData).then(() => initialData);
                }
                return docSnap.data();
            }).then(data => {
                // Now set up the real-time listener
                window.db.collection('artifacts').doc(window.appId).collection('users').doc(userId).collection('limits').doc('daily_usage').onSnapshot((doc) => {
                    const data = doc.data();
                    if (!data) return;

                    const now = new Date();
                    const lastResetDate = new Date(data.lastReset);
                    const isNewDay = now.getUTCDate() !== lastResetDate.getUTCDate() || now.getUTCMonth() !== lastResetDate.getUTCMonth() || now.getUTCFullYear() !== lastResetDate.getUTCFullYear();
                    let testsUsed = data.testsUsed || 0;
                    let tier = data.tier || 'FREE';

                    if (isNewDay && tier !== 'PRO' && tier !== 'ULTRA') {
                        // Reset count for FREE/STANDARD users
                        testsUsed = 0;
                        window.db.collection('artifacts').doc(window.appId).collection('users').doc(userId).collection('limits').doc('daily_usage').update({ testsUsed: 0, lastReset: new Date().toISOString() }).catch(console.error);
                    } else if (isNewDay && (tier === 'PRO' || tier === 'ULTRA')) {
                        // Just update reset time for PRO/ULTRA without changing count (always Infinity)
                        window.db.collection('artifacts').doc(window.appId).collection('users').doc(userId).collection('limits').doc('daily_usage').update({ lastReset: new Date().toISOString() }).catch(console.error);
                    }

                    updateUIBasedOnTier(tier, testsUsed);
                }, (error) => {
                    console.error("Firestore Listener Error:", error);
                    document.getElementById('statusMessage').textContent = "ERROR: Cannot connect to Firebase limits.";
                });
            }).catch(error => {
                console.error("Initial Doc Check/Setup Error:", error);
                document.getElementById('statusMessage').textContent = "ERROR: Failed to initialize user limits.";
            });
        };

        window.updateUIBasedOnTier = (tier, testsUsed) => {
            const T = window.translations[window.currentLang];
            window.userTier = tier;
            let maxTests, optimizationEnabled, customCodeEnabled;

            if (tier === 'FREE') {
                maxTests = 3;
                optimizationEnabled = false;
                customCodeEnabled = false;
            } else if (tier === 'STANDARD') {
                maxTests = 20;
                optimizationEnabled = false;
                customCodeEnabled = false;
            } else if (tier === 'PRO' || tier === 'ULTRA') {
                maxTests = Infinity;
                optimizationEnabled = true;
                customCodeEnabled = true;
            } else {
                maxTests = 3;
                optimizationEnabled = false;
                customCodeEnabled = false;
            }

            window.maxTests = maxTests;
            const remaining = maxTests === Infinity ? T['tests_remaining_label_unlimited'] || 'UNLIMITED' : Math.max(0, maxTests - testsUsed);

            // 1. Update Status Card
            document.getElementById('tierDisplay').textContent = tier;
            document.getElementById('testsUsedDisplay').textContent = remaining;
            document.getElementById('accountTier').textContent = tier;

            // 2. Control Buttons & Inputs
            const isFreeOrStandard = tier === 'FREE' || tier === 'STANDARD';

            // Backtest is always available until limit is hit
            const canRun = (maxTests === Infinity || testsUsed < maxTests);
            document.getElementById('runBacktestButton').disabled = !canRun;
            document.getElementById('backtestCostDisplay').textContent = isFreeOrStandard ? '1' : T['test_cost_label_free'] || 'FREE';

            // Optimization button
            document.getElementById('runOptimizationButton').disabled = !optimizationEnabled;

            // Custom Code option
            const customCodeOption = document.getElementById('strategySelect').querySelector('option[value="custom_code"]');
            if (customCodeOption) {
                customCodeOption.disabled = !customCodeEnabled;
                if(customCodeEnabled) {
                    customCodeOption.textContent = T['custom_code_option'].replace('(PRO)', '');
                } else {
                    customCodeOption.textContent = T['custom_code_option'];
                    // If user is not PRO/ULTRA, switch them back to EMA if they were on Custom Code
                    if(document.getElementById('strategySelect').value === 'custom_code') {
                        document.getElementById('strategySelect').value = 'ema_crossover';
                        window.toggleStrategyInput();
                    }
                }
            }
        };

        window.toggleModal = (id) => {
            const modal = document.getElementById(id);
            modal.classList.toggle('hidden');
        };

        window.toggleStrategyInput = () => {
            const strategy = document.getElementById('strategySelect').value;
            document.getElementById('emaParams').classList.toggle('hidden', strategy !== 'ema_crossover');
            document.getElementById('customCode').classList.toggle('hidden', strategy !== 'custom_code');

            if (strategy === 'custom_code' && (window.userTier !== 'PRO' && window.userTier !== 'ULTRA')) {
                const T = window.translations[window.currentLang];
                alert(T['custom_code_disabled']);
                document.getElementById('strategySelect').value = 'ema_crossover';
                window.toggleStrategyInput();
            }
        };

        window.initDatePickers = () => {
            const now = new Date();
            const threeYearsAgo = new Date();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –Ω–∞ 3 –≥–æ–¥–∞ –Ω–∞–∑–∞–¥
            threeYearsAgo.setFullYear(now.getFullYear() - 3);
            
            const formatDate = (date) => date.toISOString().split('T')[0];
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ–±–æ–∏—Ö –ø–æ–ª–µ–π –∫–∞–∫ –¢–ï–ö–£–©–ò–ô –î–ï–ù–¨
            const dateInputMax = formatDate(now);
            
            const startDateEl = document.getElementById('startDate');
            const endDateEl = document.getElementById('endDate');

            if (startDateEl && endDateEl) {
                 startDateEl.setAttribute('max', dateInputMax);
                 endDateEl.setAttribute('max', dateInputMax);

                 // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                 endDateEl.value = dateInputMax;
                 startDateEl.value = formatDate(threeYearsAgo);
            }
        };

        window.loadPricingContent = () => {
            // Load pricing_page.md content into the modal
            fetch('pricing_page.md')
                .then(response => {
                    if (!response.ok) throw new Error("Could not load pricing page.");
                    return response.text();
                })
                .then(text => {
                    // Simple conversion of Markdown to HTML (for demonstration)
                    const htmlContent = window.markdownToHtml(text);
                    document.getElementById('pricingContent').innerHTML = htmlContent;
                })
                .catch(error => {
                    document.getElementById('pricingContent').innerHTML = `<p class="text-red-500">${window.translations[window.currentLang]['api_error']} (Pricing page load failed)</p>`;
                    console.error("Error loading pricing page:", error);
                });
        };

        window.markdownToHtml = (markdown) => {
            // Very simple Markdown to HTML conversion for the modal
            return markdown
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*)\*/gim, '<em>$1</em>')
                .replace(/\|([^|]+)\|/g, (match, p1) => `<span style="padding: 0 10px;">${p1.trim()}</span>`);
            // Note: Full HTML rendering for the pricing page is handled by direct injection of the styled HTML from pricing_page.md
        };

        // --- DATA FETCHING ---
        window.fetchRealData = async (ticker, timeframe, startDate, endDate) => {
            const T = window.translations[window.currentLang];
            // This key is required to be passed by the user, we use a placeholder/demo key for function testing
            const apiKey = 'X1V949310TEY5ES2'; // Placeholder or user-provided key if we had an input for it
            const BASE_URL = 'https://www.alphavantage.co/query?';

            let functionCall;
            let intervalParam = '';

            if (timeframe === 'Daily') {
                functionCall = 'TIME_SERIES_DAILY_ADJUSTED';
            } else {
                // Intraday for 30min, 60min. We treat 4h as 60min data
                functionCall = 'TIME_SERIES_INTRADAY';
                // Alpha Vantage uses '30min', '60min'. We use '60min' for 4h as a proxy.
                intervalParam = `&interval=${timeframe === '4h' ? '60min' : timeframe}`;
            }

            const url = `${BASE_URL}function=${functionCall}&symbol=${ticker}&outputsize=full${intervalParam}&apikey=${apiKey}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("API call failed.");

                const data = await response.json();

                if (data["Error Message"] || data["Note"]) {
                    throw new Error(data["Error Message"] || data["Note"] || "API returned an error.");
                }

                let timeSeriesKey;
                if (timeframe === 'Daily') {
                    timeSeriesKey = "Time Series (Daily)";
                } else {
                    timeSeriesKey = `Time Series (${timeframe === '4h' ? '60min' : timeframe})`;
                }

                const rawData = data[timeSeriesKey];

                if (!rawData) throw new Error("No time series data found in API response.");

                const processedData = [];
                const start = new Date(startDate);
                const end = new Date(endDate);

                // Process and filter data
                for (const dateStr in rawData) {
                    const date = new Date(dateStr);
                    if (date >= start && date <= end) {
                        const item = rawData[dateStr];
                        processedData.push({
                            date: dateStr,
                            price: parseFloat(item['4. close']),
                            volume: parseInt(item['5. volume'])
                        });
                    }
                }

                // Sort by date ascending
                processedData.sort((a, b) => new Date(a.date) - new Date(b.date));

                if (processedData.length < 2) throw new Error("Not enough data for the selected range.");

                return processedData;

            } catch (error) {
                console.error("Data Fetching Error:", error);
                document.getElementById('statusMessage').textContent = `${T['api_error']}: ${error.message}`;
                return null;
            }
        };

        // --- TECHNICAL INDICATORS & STRATEGY EXECUTION ---
        window.calculateEMA = (data, period, key = 'price') => {
            const k = 2 / (period + 1);
            let ema = [];
            let sum = 0;

            // Initial SMA for the first EMA value
            for(let i = 0; i < period && i < data.length; i++) {
                sum += data[i][key];
            }

            if (data.length >= period) {
                ema.push(sum / period);
            } else {
                // Not enough data, fill with placeholders
                for(let i = 0; i < data.length; i++) {
                    ema.push(null);
                }
                return ema;
            }

            // Calculate subsequent EMAs
            for (let i = period; i < data.length; i++) {
                const previousEMA = ema[ema.length - 1];
                const currentPrice = data[i][key];
                const currentEMA = (currentPrice - previousEMA) * k + previousEMA;
                ema.push(currentEMA);
            }

            // Pad the beginning with nulls to match the data length
            return [...Array(period - 1).fill(null), ...ema];
        };

        window.executeStrategy = (data, fastPeriod, slowPeriod, strategyCode = null) => {
            const processedData = data.map(d => ({ ...d }));

            // 1. Calculate EMAs
            const fastEMA = calculateEMA(processedData, fastPeriod);
            const slowEMA = calculateEMA(processedData, slowPeriod);

            // Combine indicators with data
            const analysisData = processedData.map((d, i) => ({ ...d, fastEMA: fastEMA[i], slowEMA: slowEMA[i] }));

            let equity = [1000]; // Starting capital
            let trades = 0;
            let inPosition = false;
            let lastTradePrice = 0;
            let buySignals = [];
            let sellSignals = [];

            const tradeData = {
                fastEMA: fastEMA,
                slowEMA: slowPeriod,
                price: processedData.map(d => d.price),
                date: processedData.map(d => d.date)
            };

            for (let i = 1; i < analysisData.length; i++) {
                const prev = analysisData[i - 1];
                const current = analysisData[i];

                let buySignal = false;
                let sellSignal = false;

                if (strategyCode) {
                    try {
                        // Execute custom user code
                        const userLogic = new Function('tradeData', 'i', strategyCode);
                        const result = userLogic(tradeData, i);
                        buySignal = result === 'BUY';
                        sellSignal = result === 'SELL';
                    } catch (e) {
                        console.error("Custom Code Error:", e);
                        // Fallback or just stop trading
                        break;
                    }
                } else {
                    // EMA Crossover Logic (Default)
                    if (current.fastEMA > current.slowEMA && prev.fastEMA <= prev.slowEMA) {
                        buySignal = true; // Fast crosses Slow upwards
                    } else if (current.fastEMA < current.slowEMA && prev.fastEMA >= prev.slowEMA) {
                        sellSignal = true; // Fast crosses Slow downwards
                    }
                }

                let currentEquity = equity[equity.length - 1];

                if (buySignal && !inPosition) {
                    inPosition = true;
                    lastTradePrice = current.price;
                    trades++;
                    buySignals.push({ x: current.date, y: current.price });
                    window.sendTelegramSignal(document.getElementById('ticker').value, 'BUY');
                } else if (sellSignal && inPosition) {
                    // Close position: Calculate P&L
                    const profitLossPercent = (current.price - lastTradePrice) / lastTradePrice;
                    currentEquity = currentEquity * (1 + profitLossPercent);
                    inPosition = false;
                    sellSignals.push({ x: current.date, y: current.price });
                    window.sendTelegramSignal(document.getElementById('ticker').value, 'SELL');
                }

                // If in position, equity stays flat for simulation simplicity (or grows/shrinks with price)
                // For simplified equity curve, we assume capital is fully invested during the trade
                if (inPosition && i < analysisData.length - 1) {
                    const priceChange = (analysisData[i+1].price - analysisData[i].price) / analysisData[i].price;
                    currentEquity = currentEquity * (1 + priceChange);
                }

                equity.push(currentEquity);
            }

            // Handle open position at the end of the test
            if (inPosition) {
                const finalPrice = analysisData[analysisData.length - 1].price;
                const profitLossPercent = (finalPrice - lastTradePrice) / lastTradePrice;
                equity[equity.length - 1] = equity[equity.length - 1] * (1 + profitLossPercent);
                inPosition = false; // Closed at market close
            }

            // Pad equity data to match price data length
            while (equity.length < analysisData.length) {
                equity.unshift(1000); // Pad with starting capital for initial nulls
            }

            // Calculate Max Drawdown
            const equityArray = equity.filter(e => e !== undefined && e !== null);
            let maxDrawdown = 0;
            let peak = equityArray[0] || 1000;
            for(const value of equityArray) {
                if (value > peak) {
                    peak = value;
                }
                const drawdown = (peak - value) / peak;
                if (drawdown > maxDrawdown) {
                    maxDrawdown = drawdown;
                }
            }

            const finalEquity = equityArray[equityArray.length - 1] || 1000;
            const netReturn = (finalEquity - 1000) / 1000;

            return {
                dates: analysisData.map(d => d.date),
                prices: analysisData.map(d => d.price),
                fastEMA: analysisData.map(d => d.fastEMA),
                slowEMA: analysisData.map(d => d.slowEMA),
                equity: equity,
                netReturn: netReturn,
                maxDrawdown: maxDrawdown,
                totalTrades: trades,
                buySignals: buySignals,
                sellSignals: sellSignals
            };
        };

        window.renderChart = (data) => {
            const ctx = document.getElementById('priceChart').getContext('2d');

            const backgroundColors = data.buySignals.map(signal => ({
                type: 'point',
                xValue: signal.x,
                yValue: signal.y,
                pointStyle: 'triangle',
                radius: 7,
                backgroundColor: 'rgba(16, 185, 129, 0.8)', // Green
            })).concat(data.sellSignals.map(signal => ({
                type: 'point',
                xValue: signal.x,
                yValue: signal.y,
                pointStyle: 'triangle',
                rotation: 180,
                radius: 7,
                backgroundColor: 'rgba(239, 68, 68, 0.8)', // Red
            })));

            const chartData = {
                labels: data.dates,
                datasets: [
                    {
                        label: 'Price',
                        data: data.prices,
                        borderColor: '#9ca3af', // gray-400
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        yAxisID: 'yPrice',
                        pointRadius: 0,
                    },
                    {
                        label: 'Fast EMA',
                        data: data.fastEMA,
                        borderColor: '#f59e0b', // Amber (Fast trend)
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        yAxisID: 'yPrice',
                        pointRadius: 0,
                    },
                    {
                        label: 'Slow EMA',
                        data: data.slowEMA,
                        borderColor: '#3b82f6', // Blue (Slow trend)
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        yAxisID: 'yPrice',
                        pointRadius: 0,
                    },
                    {
                        label: 'Equity',
                        data: data.equity,
                        borderColor: '#10b981', // Emerald (Equity curve)
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        yAxisID: 'yEquity',
                        pointRadius: 0,
                        fill: 'origin',
                    },
                ],
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    yPrice: {
                        type: 'linear',
                        display: 'auto',
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Price',
                            color: '#d1d5db'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#d1d5db'
                        }
                    },
                    yEquity: {
                        type: 'linear',
                        display: 'auto',
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Equity',
                            color: '#10b981'
                        },
                        grid: {
                            drawOnChartArea: false, // Only draw the grid for the price axis
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#10b981',
                            callback: function(value) {
                                return `$${value.toFixed(0)}`;
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#d1d5db'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#d1d5db'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(2);
                                }
                                return label;
                            }
                        }
                    },
                    annotation: {
                        annotations: backgroundColors
                    }
                }
            };

            if (window.priceChart